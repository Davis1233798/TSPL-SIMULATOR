# TSPL Simulator 測試指南

## 🎯 當前狀態

✅ **前端**: 正在運行 (http://localhost:3000)
- npm 依賴已安裝
- 開發伺服器已啟動
- 等待編譯完成...

⏳ **後端**: 待啟動

---

## 🚀 啟動後端 (必須步驟)

### 1. 開啟新的 PowerShell 視窗

不要關閉前端的視窗,打開一個**新的** PowerShell 視窗

### 2. 進入後端目錄並啟動

```powershell
cd C:\Users\solidityDeveloper\TSPL-simlator\backend
go run main.go
```

### 3. 預期輸出

你應該看到類似以下的輸出:

```
2025/11/15 21:20:00 儲存服務已初始化: ./data
2025/11/15 21:20:00 MQTT 未配置,跳過初始化
2025/11/15 21:20:00 伺服器運行於 :8080
2025/11/15 21:20:00 API 資料儲存路徑: ./data/API_print
2025/11/15 21:20:00 MQTT 資料儲存路徑: ./data/MQTT_print
```

如果看到這些訊息,表示後端**成功啟動**! ✅

---

## 🧪 完整測試流程

確保**前端和後端都在運行**後,按以下步驟測試:

### 測試 1: 正確的 TSPL 語法 ✅

#### 步驟:
1. 打開瀏覽器 http://localhost:3000
2. 在左側編輯器輸入:
```tspl
SIZE 100 mm, 50 mm
GAP 3 mm, 0 mm
CLS
TEXT 100,100,"3",0,1,1,"Hello TSPL!"
PRINT 1,1
```
3. 點擊「預覽」按鈕

#### 預期結果:
- ✅ 前端語法檢查顯示: **✓ 無錯誤**
- ✅ 右側預覽區域顯示渲染的標籤
- ✅ 後端控制台輸出:
```
2025/11/15 21:25:30 API 資料已儲存至: data/API_print/2025_11_15/21_25_30.tspl
```
- ✅ 檔案已建立在 `backend\data\API_print\2025_11_15\21_25_30.tspl`

---

### 測試 2: 缺少必要命令 (SIZE) ❌

#### 步驟:
1. 清空編輯器,輸入:
```tspl
GAP 3 mm, 0 mm
CLS
TEXT 100,100,"3",0,1,1,"Test"
PRINT 1,1
```
2. 點擊「預覽」按鈕

#### 預期結果:
- ⚠️ 前端語法檢查顯示: **⚠️ 建議使用 SIZE 指令設定標籤尺寸**
- ❌ 後端驗證失敗
- ❌ 左側下方顯示 **ValidationErrors 元件** (紅色背景):
```
後端驗證錯誤
1 個錯誤

❌ 行 0
   命令: SIZE
   缺少必要的 SIZE 命令

💡 提示: 請修正上述錯誤後再次嘗試渲染
```
- ❌ 右側預覽區域無內容
- ❌ 後端控制台顯示: **不會儲存檔案**

---

### 測試 3: 參數超出範圍 (DIRECTION) ❌

#### 步驟:
1. 清空編輯器,輸入:
```tspl
SIZE 100 mm, 50 mm
DIRECTION 99
CLS
PRINT 1,1
```
2. 點擊「預覽」按鈕

#### 預期結果:
- ❌ 後端驗證失敗
- ❌ ValidationErrors 元件顯示:
```
後端驗證錯誤
1 個錯誤

❌ 行 2
   命令: DIRECTION
   方向必須在 0-3 之間
```

---

### 測試 4: TEXT 命令格式錯誤 ❌

#### 步驟:
1. 清空編輯器,輸入:
```tspl
SIZE 100 mm, 50 mm
CLS
TEXT 100,100,3,0,1,1,Hello
PRINT 1,1
```
2. 點擊「預覽」按鈕

#### 預期結果:
- ❌ **前端語法檢查** 即時顯示錯誤:
```
語法檢查
✗ 1 個錯誤

❌ 行 3: TEXT 指令格式錯誤。正確格式: TEXT x,y,"font",rotation,x_scale,y_scale,"content"
```
- ❌ **後端驗證** 也失敗
- ❌ ValidationErrors 元件顯示:
```
後端驗證錯誤
1 個錯誤

❌ 行 3
   命令: TEXT
   TEXT 命令格式錯誤。正確格式: TEXT x,y,"font",rotation,x-scale,y-scale,"content"
```

---

### 測試 5: 多個錯誤 ❌❌❌

#### 步驟:
1. 清空編輯器,輸入:
```tspl
DIRECTION 99
CLS
TEXT 100,100,3,0,1,1,Error
```
2. 點擊「預覽」按鈕

#### 預期結果:
- ❌ ValidationErrors 元件顯示 **3 個錯誤**:
```
後端驗證錯誤
3 個錯誤

❌ 行 0
   命令: SIZE
   缺少必要的 SIZE 命令

❌ 行 1
   命令: DIRECTION
   方向必須在 0-3 之間

❌ 行 3
   命令: TEXT
   TEXT 命令格式錯誤。正確格式: TEXT x,y,"font",rotation,x-scale,y-scale,"content"
```

---

### 測試 6: 使用範例選擇器 📋

#### 步驟:
1. 點擊左上方的「選擇範例」下拉選單
2. 選擇「基本文字標籤」
3. 點擊「預覽」按鈕

#### 預期結果:
- ✅ 自動填入完整的 TSPL 程式碼
- ✅ 語法檢查通過
- ✅ 成功渲染預覽
- ✅ 檔案已儲存

---

### 測試 7: 錯誤自動清除 🔄

#### 步驟:
1. 輸入有錯誤的 TSPL (例如缺少 SIZE)
2. 點擊「預覽」→ 顯示錯誤
3. 修改程式碼,添加 `SIZE 100 mm, 50 mm` 在第一行
4. **不需要點擊預覽**,只是修改程式碼

#### 預期結果:
- ✅ 當你修改程式碼時,ValidationErrors 元件**自動消失**
- ✅ 錯誤訊息自動清除

---

## 📁 檢查儲存的檔案

### 查看已儲存的 TSPL 檔案

```powershell
# 列出所有儲存的檔案
ls backend\data\API_print\*\*.tspl

# 查看今天的檔案
ls backend\data\API_print\2025_11_15\

# 讀取特定檔案內容
cat backend\data\API_print\2025_11_15\21_30_45.tspl
```

### 預期的檔案結構

```
backend\data\API_print\
└── 2025_11_15\              ← 今天的日期 (年_月_日)
    ├── 21_25_30.tspl        ← 21:25:30 提交的請求
    ├── 21_26_15.tspl        ← 21:26:15 提交的請求
    └── 21_30_00.tspl        ← 21:30:00 提交的請求
```

每個檔案包含提交的完整 TSPL 程式碼。

---

## 🎨 UI 元件驗證清單

測試過程中,確認以下 UI 元件正常運作:

### 左側面板
- [ ] **範例選擇器** - 下拉選單可以選擇範例
- [ ] **TSPL 編輯器** - 可以輸入和編輯 TSPL 程式碼
- [ ] **前端語法檢查器** - 即時顯示錯誤和警告
- [ ] **控制面板** - 預覽和清除按鈕
- [ ] **ValidationErrors 元件** - 後端錯誤顯示 (紅色背景)
- [ ] **錯誤訊息** - 一般錯誤訊息 (當無驗證錯誤時)

### 右側面板
- [ ] **標籤預覽** - Canvas 渲染區域
- [ ] **載入動畫** - 點擊預覽時顯示 "渲染中..."
- [ ] **後端狀態指示器** - 顯示後端連接狀態

---

## 🔍 後端控制台日誌驗證

### 成功請求的日誌

```
2025/11/15 21:25:30 API 請求: POST /api/render
2025/11/15 21:25:30 TSPL 驗證通過
2025/11/15 21:25:30 API 資料已儲存至: data/API_print/2025_11_15/21_25_30.tspl
```

### 驗證失敗的日誌

```
2025/11/15 21:26:00 API 請求: POST /api/render
2025/11/15 21:26:00 TSPL 驗證失敗:
2025/11/15 21:26:00   行 0 [SIZE]: 缺少必要的 SIZE 命令
2025/11/15 21:26:00   行 2 [DIRECTION]: 方向必須在 0-3 之間
```

---

## 🐛 常見問題排除

### 問題 1: 前端顯示 "後端不可用"

**症狀**: 前端右上角顯示紅色 "後端不可用" 標籤

**解決方案**:
1. 確認後端是否正在運行 (`go run main.go`)
2. 檢查後端端口是否為 8080
3. 檢查 `frontend\.env` 中的 `REACT_APP_API_URL=http://localhost:8080/api`
4. 檢查防火牆是否阻擋 8080 端口

### 問題 2: 點擊預覽後無反應

**症狀**: 點擊預覽按鈕後,沒有任何錯誤,也沒有渲染

**解決方案**:
1. 打開瀏覽器開發者工具 (F12)
2. 查看 Console 標籤是否有錯誤
3. 查看 Network 標籤,檢查 API 請求狀態
4. 確認後端控制台是否收到請求

### 問題 3: ValidationErrors 不顯示

**症狀**: 有錯誤但不顯示紅色的 ValidationErrors 元件

**解決方案**:
1. 確認後端已啟動 (如果後端未啟動,會使用 mockApi,不會有 ValidationErrors)
2. 確認後端返回 `validation_errors` 陣列
3. 檢查瀏覽器 Console 是否有 React 錯誤

### 問題 4: 檔案沒有儲存

**症狀**: 後端控制台沒有顯示 "API 資料已儲存至..." 訊息

**原因**: 只有**驗證通過**的 TSPL 才會儲存檔案

**確認**:
- 如果有驗證錯誤,後端**不會儲存檔案**
- 只有成功渲染的請求才會儲存

---

## ✅ 完整功能驗證清單

測試完成後,確認以下所有功能都正常運作:

### 前端功能
- [ ] 範例選擇器載入並填入範例程式碼
- [ ] TSPL 編輯器可以編輯程式碼
- [ ] 前端即時語法檢查正常運作
- [ ] 提交正確 TSPL 成功渲染預覽
- [ ] 提交錯誤 TSPL 顯示 ValidationErrors 元件
- [ ] 錯誤訊息包含行號、命令和錯誤描述
- [ ] 修改程式碼後錯誤自動清除
- [ ] 清除按鈕可以清除預覽和錯誤
- [ ] 後端狀態指示器顯示連接狀態

### 後端功能
- [ ] 後端成功啟動在端口 8080
- [ ] 接收 API 請求並進行驗證
- [ ] 驗證通過時儲存檔案到正確路徑
- [ ] 驗證失敗時返回詳細錯誤
- [ ] 檔案按日期組織 (年_月_日 資料夾)
- [ ] 檔案名稱為時間戳記 (時_分_秒.tspl)
- [ ] CORS 正確配置,前端可以調用 API
- [ ] 控制台日誌清晰顯示請求和結果

### 驗證功能
- [ ] 檢測缺少 SIZE 命令
- [ ] 檢測缺少 PRINT 命令
- [ ] 檢測 DIRECTION 參數超出範圍 (0-3)
- [ ] 檢測 DENSITY 參數超出範圍 (0-15)
- [ ] 檢測 SPEED 參數超出範圍 (1-14)
- [ ] 檢測 TEXT 命令格式錯誤
- [ ] 檢測 BARCODE 命令格式錯誤
- [ ] 檢測 QRCODE 命令格式錯誤
- [ ] 檢測未知命令
- [ ] 可以同時顯示多個錯誤

---

## 🎓 進階測試

### 測試 BARCODE 命令

```tspl
SIZE 100 mm, 50 mm
GAP 3 mm, 0 mm
CLS
BARCODE 100,100,"128",100,1,0,2,2,"1234567890"
PRINT 1,1
```

### 測試 QRCODE 命令

```tspl
SIZE 100 mm, 50 mm
GAP 3 mm, 0 mm
CLS
QRCODE 100,100,H,6,A,0,"https://example.com"
PRINT 1,1
```

### 測試 BOX 命令

```tspl
SIZE 100 mm, 50 mm
GAP 3 mm, 0 mm
CLS
BOX 50,50,200,200,5
PRINT 1,1
```

---

## 📊 測試結果記錄

建議記錄每個測試的結果:

| 測試編號 | 測試項目 | 預期結果 | 實際結果 | 狀態 |
|---------|---------|---------|---------|------|
| 1 | 正確 TSPL 渲染 | 成功渲染 + 檔案儲存 | | ⬜ |
| 2 | 缺少 SIZE 命令 | 顯示 ValidationErrors | | ⬜ |
| 3 | DIRECTION 超出範圍 | 顯示驗證錯誤 | | ⬜ |
| 4 | TEXT 格式錯誤 | 前後端都檢測錯誤 | | ⬜ |
| 5 | 多個錯誤 | 顯示所有錯誤 | | ⬜ |
| 6 | 範例選擇器 | 自動填入並渲染 | | ⬜ |
| 7 | 錯誤自動清除 | 修改程式碼清除錯誤 | | ⬜ |

---

## 🎯 下一步

測試通過後,你可以:

1. **添加更多範例**: 在前端添加更多 TSPL 範例
2. **測試 MQTT 功能**: 配置 MQTT Broker 並測試
3. **改進 UI**: 添加語法高亮、行號高亮
4. **部署**: 編譯並部署到生產環境
5. **文件**: 為使用者編寫使用手冊

---

**祝測試順利!** 🎉

如果遇到任何問題,請參考 [RUNNING_THE_PROJECT.md](RUNNING_THE_PROJECT.md) 的故障排除部分。
